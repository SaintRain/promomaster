{#**
 *  Шаблон для костомных полей у формы редактирования продукта
 *
 * @author Sergeev A.M.
 * @copyright LLC "PromoMaster"
 *#}


{#  Переопределение вывода краткого описания #}
{% block  core_shop_product_admin_isCanBeInYml_checkbox_widget %}
    {{ form_widget(form) }}
    {% if sonata_admin.admin.subject.id%}
    {% if not sonata_admin.admin.subject.isCanBeInYml
    or not sonata_admin.admin.subject.manufacturerMain.isCanBeInYml
    or (not sonata_admin.admin.subject.orderOnly and not sonata_admin.admin.subject.availabilityQuantity)
    or sonata_admin.admin.subject.isDiscontinued %}
        {#если товар не под заказ и его нет в наличии#}
        {% if not sonata_admin.admin.subject.availabilityQuantity and not sonata_admin.admin.subject.orderOnly %}
            <span title="Не включено в YML" class="label label-important">Нет в наличии</span>
        {% else %}
            {% if not sonata_admin.admin.subject.isCanBeInYml %}
                <span title="Не включено в YML" class="label label-important">Отменена публикация товара</span>
            {% else %}
                {% if not sonata_admin.admin.subject.manufacturerMain.isCanBeInYml %}
                    <span title="Не включено в YML" class="label label-important">Отменена публикация производителя</span>
                {% else %}
                    {% if sonata_admin.admin.subject.isDiscontinued %}
                        <span title="Не включено в YML" class="label label-important">Снят с производства</span>
                {% endif %}
                {% endif %}
            {% endif %}
        {% endif %}
    {% else %}
        <span class="label label-success">Включено в YML</span>
    {% endif %}
    {% endif %}
{% endblock %}

{#  Переопределение вывода краткого описания #}
{% block  core_shop_product_admin_descriptionRu_ckeditor_widget %}

    {% if sonata_admin.admin.subject.isDescriptionSendToYandex %}
        {% set imagePrefix='' %}
    {% else %}
        {% set imagePrefix='dont_' %}
    {% endif %}
    <img data-target="isDescriptionSendToYandex" class="sendEmailOrderStatus"
         title="Нужно ли отправлять текст в YandexMarket при обновлении описания"
         src="{{ asset('bundles/coreorder/Admin/img/'~imagePrefix~'send_email.png') }}"/>
    {{ form_widget(form) }}
    <script>
        $(function () {
            $('img.sendEmailOrderStatus').click(function () {
                var dataTarget = $(this).attr('data-target'),
                        $checkbox = $('input[id $= "_' + dataTarget + '"]').first();
                if ($checkbox.is(':checked')) {
                    $(this).attr('src', "{{asset('bundles/coreorder/Admin/img/dont_send_email.png')}}");
                    $checkbox.removeAttr('checked');
                }
                else {
                    $(this).attr('src', "{{asset('bundles/coreorder/Admin/img/send_email.png')}}");
                    $checkbox.attr('checked', 'checked');
                }
            })
        })
    </script>
{% endblock %}


{% block  core_shop_product_admin_isNoSerials_checkbox_widget %}
    {{ form_widget(form) }}
    <script>
        //скрываем/показываем поле ввода серийных номеров
        $(function () {
            var uniqid = "{{sonata_admin.admin.uniqid}}";
            toogleSerialsQuantity();

            $('#' + uniqid + '_isNoSerials').change(function () {
                toogleSerialsQuantity();
            });
            function toogleSerialsQuantity() {
                var $obj = $('#' + uniqid + '_isNoSerials');
                if ($obj.is(':checked')) {
                    $('#' + uniqid + '_serialsQuantity').parents('div.control-group').hide();
                }
                else {
                    $('#' + uniqid + '_serialsQuantity').parents('div.control-group').show();
                }
            }
        });
    </script>
{% endblock %}

{# переписываем вывод количества товара у поставщика#}
{% block  core_shop_product_admin_OOPBQuantity_integer_widget %}
    <div style="width:250px;float: left">{{ form_widget(form) }}
        {% if sonata_admin.admin.subject.OOPBQuantityUpdated %}
            <span class="label label-default"
                  title="Дата обновления остатка">{{ sonata_admin.admin.subject.OOPBQuantityUpdated|date("d-m-Y H:i:s", default_timezone) }}</span>
        {% endif %}
    </div>
    <div class="clearfix"></div>
{% endblock %}

{# переписываем вывод количества товара у поставщика#}
{% block  core_shop_product_admin_deliveryDays_integer_widget %}
    <div style="width:250px;float: left">
        {{ form_widget(form) }}
    </div>
    <div class="clearfix"></div>
{% endblock %}



{% block  core_shop_product_admin_isDescriptionSendToYandex_checkbox_widget %}
    <span style='display: none'>{{ form_widget(form) }}</span>
{% endblock %}

{% block  core_shop_product_admin_isOOPBCurrencyRateAdditiveInPercent_checkbox_widget %}
    {{ form_widget(form) }}<br/>
    Курс ЦБР: <span id="selectedCurencyRate" class="money"></span> <span class="money">{{ currencyFormat() }}</span>
    <span class="label label-default" title="Дата обновления курса" id="currencyDateTime"></span><br/>
    Курс с амортизацией: <span id="selectedCurencyRateWithAdditive" class="money"></span> <span
        class="money">{{ currencyFormat() }}</span><br>
    Цена закупки: <span id="selectedCurencyRateCompute" class="money"></span> <span
        class="money">{{ currencyFormat() }}</span>
{% endblock %}


{% block  core_shop_product_admin_orderOnlyShopTaxInPercent_checkbox_widget %}
    {{ form_widget(form) }}
    <br/><br/>
    <div class="control-group">Расчетная цена: <span class="money" id="rashetnayaStoimost">0</span> <span
                class="money">{{ currencyFormat() }}</span></div>
    <div class="control-group">Прибыль: <span class="money" id="pribil">0</span> <span
                class="money">{{ currencyFormat() }}</span></div>
    <script>
        $(document).ready(function () {
            rashetnayaStoimost();
            var uniqid = "{{sonata_admin.admin.uniqid}}";

            $('#' + uniqid + '_orderOnlyPriceBuying').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_OOPBCurrency').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_OOPBCurrencyRateAdditive').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_isOOPBCurrencyRateAdditiveInPercent').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_mrc').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_isMrcEnabled').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_orderOnlyShopTax').change(function () {
                rashetnayaStoimost();
            });
            $('#' + uniqid + '_orderOnlyShopTaxInPercent').change(function () {
                rashetnayaStoimost();
            });

        });

        //расчетная стоимость под заказ
        function rashetnayaStoimost() {
            var
                    uniqid = "{{sonata_admin.admin.uniqid}}",
                    newPrice = 0,
                    orderOnlyPriceBuying = $('#' + uniqid + '_orderOnlyPriceBuying').val(),
                    orderOnlyPriceBuying = parseFloat(orderOnlyPriceBuying.replace(',', '.')),
                    orderOnlyShopTax = parseFloat($('#' + uniqid + '_orderOnlyShopTax').val().replace(/,/g, '.')),
                    orderOnlyShopTaxInPercent = $('#' + uniqid + '_orderOnlyShopTaxInPercent').is(':checked'),
                    isMrcEnabled = $('#' + uniqid + '_isMrcEnabled').is(':checked'),
                    mrc = $('#' + uniqid + '_mrc').val(),
                    mrc = parseFloat(mrc.replace(',', '.')),
                    $OOPBCurrency = $('#' + uniqid + '_OOPBCurrency').find(":selected"),
                    OOPBCurrencyRateAdditive = $('#' + uniqid + '_OOPBCurrencyRateAdditive').val(),
                    OOPBCurrencyRateAdditive = parseFloat(OOPBCurrencyRateAdditive.replace(',', '.')),
                    isOOPBCurrencyRateAdditiveInPercent = $('#' + uniqid + '_isOOPBCurrencyRateAdditiveInPercent').is(':checked');

            if (!OOPBCurrencyRateAdditive) {
                OOPBCurrencyRateAdditive = 0;
            }

            if (!orderOnlyShopTax) {
                orderOnlyShopTax = 0;
            }
            if (!orderOnlyPriceBuying) {
                orderOnlyPriceBuying = 0;
            }

            if ($OOPBCurrency.attr('data-currencyRUB')) {
                var rate = $OOPBCurrency.attr('data-currencyRUB');
                rate = parseFloat(rate.replace(',', '.'));
                if (!rate) {
                    rate = 1;
                }
            }
            else {
                var rate = 1;
            }

            $('#selectedCurencyRate').html(number_format(rate + '', 4, ',', ''));
            if (rate == 1) {
                $("#currencyDateTime").html('').hide();
            }
            else {
                $("#currencyDateTime").html($OOPBCurrency.attr('data-currencyDateTime')).show();
            }


            //прибавляем к курсу надбавку
            if (isOOPBCurrencyRateAdditiveInPercent) {
                rate = rate + (rate / 100) * OOPBCurrencyRateAdditive;
            }
            else {
                rate = rate + OOPBCurrencyRateAdditive;
            }
            //курс с амортизацией
            $('#selectedCurencyRateWithAdditive').html(number_format(rate + '', 4, ',', ''));

            //переводим по курсу
            orderOnlyPriceBuying = orderOnlyPriceBuying * rate;

            $('#selectedCurencyRateCompute').html(number_format(Math.ceil(orderOnlyPriceBuying) + '', 2, ',', ''));

            //если MRC включена, то берем её без всяких расчетов
            if (isMrcEnabled) {
                newPrice = mrc;
            }
            else {
                if (orderOnlyShopTaxInPercent) {
                    newPrice = orderOnlyPriceBuying + ((orderOnlyPriceBuying / 100) * orderOnlyShopTax);
                }
                else {
                    newPrice = orderOnlyPriceBuying + orderOnlyShopTax * rate;
                }
            }

            newPrice = Math.ceil(newPrice);
            if (isNaN(newPrice)) {
                newPrice = 0;
            }
            var pribil = newPrice - orderOnlyPriceBuying;

            //newPrice = number_format(newPrice, 2, ',', '');
            //расчетная цена
            $('#rashetnayaStoimost').html(newPrice);
            //прибыль
            $('#pribil').html(Math.ceil(pribil));


        }
    </script>
{% endblock %}


{#  Фиксируем по ширине таблицу серийников #}
{% block core_shop_product_admin_productTags_sonata_type_collection_widget %}
    <div style="width:450px">
        {{ form_widget(form) }}
    </div>
    <script>
        $(document).ready(function () {
            $(".tagsAutocomplete").autocomplete({
                source: "{{path('core_directrory_product_tags')}}",
                minLength: 2
            });

        });
    </script>
{% endblock %}

{#  Фиксируем по ширине таблицу изображений #}
{% block core_shop_product_admin_images_multiupload_image_widget %}
    <div style="width:900px">
        {{ block('multiupload_image_widget') }}
    </div>
{% endblock %}


{# Добавление кнопки-иконки для просмотра графика изменения цены у поля Цена #}
{% block core_shop_product_admin_price_money_price_widget %}
    {% spaceless %}
        <script>

            if (core_statistics_ajax_get_chart_price_history === undefined) {
                $.getScript('{{ asset('bundles/coreproduct/Admin/js/ajax_get_chart_price_history.js') }}');
                var currencySymbol = ' {{ currencySymbol }}';
            }

            var core_statistics_ajax_get_chart_price_history = '{{ path('core_statistics_ajax_get_chart_price_history') }}';

        </script>
        <div class="pull-left">
            {{ block('money_widget') }}
        </div>

        {% if (sonata_admin.admin.subject.id) %}
            <div class="icon-graph pull-left get-chart-price-history" data-id="{{ app.request.get('id') }}"
                 title="Посмотреть график изменения цены"></div>
        {% endif %}

        <div class="clearfix"></div>
        <span class="help-block sonata-ba-field-help span5">Если товар доставляется под заказ, то цена автоматически будет пересчитываться<span
                    class="help-block-shadow"></span></span>
    {% endspaceless %}
{% endblock %}

{# Изменяем вывод флага отображения на сайте #}
{% block core_shop_product_admin_isVisible_checkbox_widget %}
    {% spaceless %}

        <div style="height: 8px"></div>

        {% if sonata_admin.admin.subject.isVisible %}

            <span class="label label-success" style="margin-top: 10px">Да</span>

        {% else %}

            <span class="label label-important">Нет</span>

        {% endif %}

    {% endspaceless %}
{% endblock %}
