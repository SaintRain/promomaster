{# Вкладка ПОДОРОЖАНИЕ#}
<div class="tab-pane priceHike" id="{{ uniqid }}_{{ ind+1 }}">
    <fieldset>
        <div class="sonata-ba-collapsed-fields">
            <p>Показаны товары только под заказ для указанного производителя. Новые закупочные цены будут
                установлены для выбранных продуктов.</p>
            <p>
                <input type="button" class="btn setNewBasePriceButton"
                       value="Установить новые закупочные цены на выбранные товары">
                &nbsp;
                <input  type="button" class="btn disabledProductButton"
                        value="Отключить от публикации выбранные товары">
                &nbsp;
                <input style="display:none" type="button" class="btn enableProductButton" value="Включить на публикацию">
            </p>

            </p>
            <h3>Фильтры</h3>
            <label style="float: left"><input checked type="radio" name="phFilter" value="phAllProducts" >&nbsp;Все товары <span id="phAllProductsQuantity"></span></label>
            <label style="float: left">&nbsp;&nbsp;&nbsp;&nbsp;<input name="phFilter" value="phPriceHike" type="radio" >&nbsp;Подорожавшие <span id="phPriceHikeQuantity"></span></label>
            <label style="float: left">&nbsp;&nbsp;&nbsp;&nbsp;<input name="phFilter" value="phDepreciation" type="radio" >&nbsp;Подешевевшие <span id="phDepreciationQuantity"></span></label>
            <label style="float: left">&nbsp;&nbsp;&nbsp;&nbsp;<input name="phFilter" value="phNothing" type="radio" >&nbsp;Без изменения <span id="phNothingQuantity"></span></label>
            <label>&nbsp;&nbsp;&nbsp;&nbsp;<input name="phFilter" value="phDisabledInBaseandHasInPrice" type="radio" >&nbsp;Сняты с публикации или производства <span id="phDisabledInBaseandHasInPriceQuantity"></span></label>
            <br/>
            <table class="table table-bordered table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th style="width: 1%">№</th>
                        <th style="width:70%">Продукт</th>
                        <th style="width:5%">Закупочная цена<br><span style="font-size:10px">На момент загрузки прайса</span></th>
                        <th style="width:5%">Цена в прайсе</th>
                        <th style="width:9%">Новая цена</th>
                        <th style="width:9%">Изменение цены</th>
                        <th style="width:1%"><input title="Выбрать все" name="setBasePriceAll"
                                                      type="checkbox" value="1"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in extra.priceHike %}
                        <tr class="priceHikeTr {{ d.extra.flag }} {{ d.extra.flag2 }} {%if d.extra.difCurrency is defined %}error{%endif%}">
                            <td nowrap>{{ loop.index }}</td>
                            <td >
                                <a href="{{ path('admin_core_product_commonproduct_edit',{id:d.product.id}) }}">{{ d.product.article }} {{ d.product.sku }} {{ d.product.captionRu }}</a>
                                <span class="money">{{moneyFormat(d.product.price) }} {{currencyFormat()}}</span>                            
                                {% if d.product.isDiscontinued %} <span class="label label-default">снят  производства</span>{%endif%}
                            </td>
                            <td nowrap>
                                <span class="money">{{ moneyFormat(extra.ph[d.product.id].orderOnlyPriceBuying) }} {{ extra.ph[d.product.id].OOPBCurrency.symbol }}</span>
                                {%if d.extra.difCurrency is defined %}
                                    <span class="label label-important">валюта отличается в прайсе</span>
                                {%endif%}
                            </td>
                            <td nowrap>
                                <span class="money">{{ moneyFormat(d.priceData.orderOnlyPriceBuying) }} {{ admin.subject.supplier.paCurrency.symbol}}</span>
                            </td>
                            <td nowrap>
                                <span class="money">{{ moneyFormat(d.extra.newPrice) }} {{ currencyFormat() }}</span>
                            </td>
                            <td nowrap>
                                <span class="money">{{ moneyFormat(d.extra.difference) }} {{ currencyFormat() }}</span>
                                ( {{ d.extra.differenceInPercent }}
                                %) {% if d.extra.flag!='nothing' %} {% if d.extra.difference > 0 %}&#8593;{% else %}&#8595;{% endif %}{% endif %}
                            </td>
                            <td>
                                {%if d.extra.difCurrency is not defined %}
                                    <input class="setBasePrice"
                                           data-product-id="{{ d.product.id }}"
                                           data-new-price="{{ d.priceData.orderOnlyPriceBuying }}"
                                           type="checkbox" value="1">
                                {%endif%}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </fieldset>
</div>
<script>
    $(function () {

        $('#phAllProductsQuantity').html('(' + $('.priceHikeTr').length + ')');
        $('#phPriceHikeQuantity').html('(' + $('.priceHikeTr.priceHike').length + ')');
        $('#phDepreciationQuantity').html('(' + $('.priceHikeTr.depreciation').length + ')');
        $('#phNothingQuantity').html('(' + $('.priceHikeTr.nothing').length + ')');
        $('#phDisabledInBaseandHasInPriceQuantity').html('(' + $('.priceHikeTr.disabledInBaseandHasInPrice').length + ')');

        //обработчики фильтров
        $('input[name="phFilter"]').change(function () {

            //сбрасываем все галочки
            $('.setBasePrice').removeAttr('checked', 'checked');
            $('input[name="setBasePriceAll"]').removeAttr('checked', 'checked');
            
            $('.enableProductButton').hide();
            $('.disabledProductButton').show();
            if ($(this).val() == 'phAllProducts') {
                $('.priceHikeTr').show();
            }
            else if ($(this).val() == 'phPriceHike') {
                $('.priceHikeTr').hide();
                $('.priceHikeTr.priceHike').show();
            }
            else if ($(this).val() == 'phDepreciation') {
                $('.priceHikeTr').hide();
                $('.priceHikeTr.depreciation').show();
            }
            else if ($(this).val() == 'phNothing') {
                $('.priceHikeTr').hide();
                $('.priceHikeTr.nothing').show();
            }
            else if ($(this).val() == 'phDisabledInBaseandHasInPrice') {
                $('.priceHikeTr').hide();
                $('.disabledProductButton').hide();
                $('.priceHikeTr.disabledInBaseandHasInPrice').show();
                $('.enableProductButton').show();
            }
            //динамическая нумерация строк
            var ind = 1;
            $('.priceHikeTr:visible').each(function () {
                $(this).find('td').first().html(ind);
                ind++;
            });
        });

        //включить товары, которые есть в прайсе и базе, но скрыты от публикации
        $('.enableProductButton').click(function () {
            var ids = [];
            if ($('input[name="phFilter"]:checked').val() == 'phDisabledInBaseandHasInPrice') {
                $('.setBasePrice:checked').each(function (obj) {
                    var item = {
                        id: $(this).attr('data-product-id')
                    }
                    ids.push(item);
                });
            }

            if (ids.length > 0) {
                $.post("{{ admin.generateObjectUrl('enableProduct', admin.subject) }}", {ids: ids})
                        .done(function (data) {
                            alert("Выбранные товары были включены на публикацию! Обновите страницу.");
                        });
            }
            else {
                alert('Отметьте продукты, которые нужно включить на публикацию.');
            }
        });

        //установить базовый цены из прайса
        $('.setNewBasePriceButton').click(function () {
            var ids = [];
            $('.setBasePrice:checked').each(function (obj) {
                var item = {
                    id: $(this).attr('data-product-id'),
                    price: $(this).attr('data-new-price')
                }
                ids.push(item);
            });
            if (ids.length > 0) {
                $.post("{{ admin.generateObjectUrl('setBasePriceForProductsFromPrice', admin.subject) }}", {ids: ids})
                        .done(function (data) {
                            alert("Новые закупочные цены установлены! Обновите страницу.");
                        });
            }
            else {
                alert('Отметьте продукты, которые нужно обновить.');
            }
        });

        //выбрать все
        $('input[name="setBasePriceAll"]').change(function () {
            if ($(this).is(':checked')) {
                $('.setBasePrice').each(function () {
                    if ($(this).parents('tr').is(':visible')) {
                        $(this).attr('checked', 'checked');
                    }
                });
            }
            else {
                $('.setBasePrice').removeAttr('checked', 'checked');
            }
        });
    });

    $(function () {
        //отключить от публикации товары, которых нет в прайсе
        $('.disabledProductButton').click(function () {
            var ids = [];
            $('.setBasePrice:checked').each(function (obj) {
                var item = {
                    id: $(this).attr('data-product-id')
                }
                ids.push(item);
            });
            if (ids.length > 0) {
                $.post("{{ admin.generateObjectUrl('disableProduct', admin.subject) }}", {ids: ids})
                        .done(function (data) {
                            alert("Выбранные товары были отключены от публикации! Обновите страницу.");
                        });
            }
            else {
                alert('Отметьте продукты, которые нужно отключить от публикации.');
            }
        });

    });
</script>