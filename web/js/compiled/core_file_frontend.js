if(!window.jQuery){alert("Необходимо подключить библиотеку jQuery!")}else{$(function(){var g,e,d=new Array(),c=0,b=5;$("body").on("click",".fake-input-file",function(h){if(!$(this).hasClass("disabled")){h.preventDefault();$(this).next('input[type="file"]').trigger("click")}});$(".CoreFileContainer").each(function(){var h=$(this).find(".ajax-file");if(h.attr("multiple")===undefined&&h.data("count_of_attached_files")>=1){}});$("body").on("change",".ajax-file",function(j){if(this.files.length){g=$(this).parent(".CoreFileContainer");d=this.files;var h=d.length;c=0;g.find(".count-of-sended").text("0");g.find(".count-of-sended").text(h<b?h:b);g.find(".count-all-to-send").text(d.length);g.find(".fake-input-file").addClass("disabled");g.find(".CoreFileCounter").fadeIn("fast");f()}});function f(){var h=d.length;if(h<c+b&&h>c){countOfSending=h-c}else{countOfSending=b}var j=new FormData;for(i=c;i<(c+countOfSending);i++){if(d[i]!==undefined){j.append("CoreFileBundleInput[filesToUpload]["+i+"]",d[i])}}j.append("CoreFileBundleInput[form_id]",g.find(".ajax-form_id").val());j.append("CoreFileBundleInput[id]",g.find(".ajax-id").val());j.append("CoreFileBundleInput[type]",g.find(".ajax-type").val());j.append("CoreFileBundleInput[fieldName]",g.find(".ajax-field").val());j.append("CoreFileBundleInput[namespace_to_attach]",g.find(".ajax-namespace_to_attach").val());j.append("CoreFileBundleInput[namespace_to_insert]",g.find(".ajax-namespace_to_insert").val());$.ajax({url:core_file_ajax_upload_file,type:"POST",data:j,cache:false,contentType:false,processData:false}).done(function(t){var w=$.parseJSON(t),l="",k="";var v,n,p;g.find(".CoreFileCounter").slideUp("fast");a(t,"main",g);c+=countOfSending;if(w.success){g.find(".count-of-sended").text(c>h?h:c);for(key in w.data){if(w.data[key]!==null&&typeof w.data[key]==="object"){if(w.data[key]["name"]){k=w.data[key]["name"]}else{for(v in w.data[key]){if(!w.data[key][v]["name"]&&!w.data[key][v]["size"]){for(n in w.data[key][v]){if(n==="original"){for(p in w.data[key][v][n]){k=w.data[key][v][n][p];l="/"+v+"/"+n+"/"+p+k}}}}else{k=w.data[key][v]["name"];l="/"+v+"/"+k}}}}else{k=w.data[key]}if(g.find(".CoreFileAttached ul li").length>1){g.find(".CoreFileAttached ul li:not(:last)").remove()}if(typeof w.isNew!=="undefined"&&w.type=="image"){var q=w.other.imginfo[w.data[0].name].base64,o='<img style="margin-top: 5px;max-height: 200px;" src="'+q+'"/>',u="Размер "+w.extraImg.height+"x"+w.extraImg.width;m=g.find(".CoreFileAttached ul li:last").clone().prependTo(g.find(".CoreFileAttached ul")).fadeIn("fast").removeClass("hidden");m.find("span.file-attachment").html(o);m.find("span.download").hide();m.find("span.size").text(u)}else{if(typeof w.isNew==="undefined"&&w.type=="image"){var o='<img style="margin-top: 5px;max-height: 200px;" src="/'+w.extraImg.path+"/original/original_"+w.data[w.extraImg.id][w.extraImg.path].original.original_+'"/>',u="Размер "+w.extraImg.height+"x"+w.extraImg.width;m=g.find(".CoreFileAttached ul li:last").clone().prependTo(g.find(".CoreFileAttached ul")).fadeIn("fast").removeClass("hidden");m.find("span.file-attachment").html(o);m.find("span.size").text(u)}else{var m=g.find(".CoreFileAttached ul li:last").clone().prependTo(g.find(".CoreFileAttached ul")).fadeIn("fast").removeClass("hidden");m.find("span.file-name").text(k.replace(/_\d+\./g,".").replace(/.+#/g,""));if(typeof w.isNew!=="undefined"){m.find("span.download").hide()}}}if(!g.find(".ajax-id").val()){g.find(".CoreFileAttached ul li:first").find("span.file-remove").attr("data-hash",k).parent("li").find("a.file-link").remove()}else{g.find(".CoreFileAttached ul li:first").find("span.file-remove").attr("data-id",key).parent("li").find("a.file-link").attr("href",l)}}}if(c<h){f()}else{var r=g.find(".ajax-file");var s=parseInt(r.data("count_of_attached_files"));r.removeAttr("value").data("count_of_attached_files",c+s);g.find(".fake-input-file").removeClass("disabled");g.find(".ajax-file").val("")}}).fail(function(){alert("Произошла ошибка при загрузке файла!");g.find(".fake-input-file").removeClass("disabled");g.find(".ajax-file").val("")})}function a(j,n,m){var h=$.parseJSON(j);var l="success";if(h.error){l="error";m.find(".disabled").removeClass("disabled")}var k;if(e){clearTimeout(e)}$(".hide-by-timer").hide();if(h[l]){if(n==="main"){k=m.find(".ajax-"+l+"-"+n)}else{k=$(".ajax-"+l+"-"+n)}k.html(h[l].join("<br>")).removeClass("hidden").css("visibility","visible").slideDown("fast");e=setTimeout(function(){k.html(h[l].join("<br>")).slideUp("fast")},k.data("hide-after")*1000)}}$("body").on("click",".file-remove",function(l){if(confirm("Подтвердите удаление файла.")){var k=$(this),j=new FormData,h=$(this).data("hash"),n=$(this).data("id"),m=$(this).closest(".CoreFileContainer");if(h){j.append("hash",h)}else{j.append("id",n)}j.append("data[form_id]",m.find(".ajax-form_id").val());j.append("data[fieldName]",m.find(".ajax-field").val());j.append("data[namespace_to_attach]",m.find(".ajax-namespace_to_attach").val());j.append("data[namespace_to_insert]",m.find(".ajax-namespace_to_insert").val());$.ajax({url:core_file_ajax_remove_file,type:"POST",data:j,cache:false,contentType:false,processData:false}).done(function(o){a(o,"main",m);k.closest("li").fadeOut(function(){$(this).remove()})})}})})};