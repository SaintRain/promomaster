(function(c){var i=[],h,d,r,p,o=true,n=null;c(function(){c(".delivery_btn").prop("disabled",true).addClass("disabled");var s=false;c(".phone_correct").inputmask({mask:"+7 (999) 999-99-99[9]",greedy:false});c(".passport").inputmask({mask:"9999 999999",greedy:true});c("#contragent_type input").click(function(){var v=c(this),u=c(".contragent_form"),w=v.val();v.prop("checked",true);u.each(function(x,y){var z=c(y);if(z.is("#"+w)){z.removeClass("hidden")}else{z.addClass("hidden")}})});c("body").on("change","#cart_buyer_recipient_contactList, #delivery_recipient_form_contactList",function(){var A=c(this),B=c("input[id^='delivery_recipient_form_contact_city']"),x=c(".select2-container.city .select2-chosen"),w=c(".select2-container.city.ajax-entity"),u=c("#indi_form, #legal_form").length,v=c(".select2-choice",w),y=A.parentsUntil("form"),z=c("option:selected",A).data("contact");if(A.val()){for(var C in z){if(C=="city"){c("."+C).val(z[C].id);x.text(z[C].caption);v.removeClass("select2-default")}else{if(u&&C=="passport"){if(z[C]){c("."+C).parents("fieldset.form_fieldset").show();c("."+C).val(z[C])}else{c("."+C).parents("fieldset.form_fieldset").hide();c("."+C).val("")}}else{c("."+C).val(z[C])}}}}else{c('select, textarea, input:not([type="hidden"])',y).each(function(D,E){var F=c(E);F.val("");if(F.hasClass("ajax-entity")){x.text("Город");v.addClass("select2-default");F.select2("val","")}})}});c("body").on("change","#delivery_recipient_form_contactList",function(){var z=c(this),w=c("option:selected",z),v=c(".recipient_close"),y=c("#contact_info"),x=w.data("contact"),u;if(!z.val()){return false}if(x.lastName){u=x.lastName+" "+x.firstName+" <br />тел."+x.phone+"<br />г."+x.city.caption+", "+x.address}else{u=x.organization+" <br />тел."+x.phone+"<br />г."+x.city.caption+", "+x.address}y.html(u);v.removeClass("hidden")});c(".register_me").change(function(){var v=c(this),w=v.parents("form"),u=c(".password",w);if(v.prop("checked")){u.removeClass("hidden")}else{u.addClass("hidden")}});c(".copy").blur(function(){var v=c(this),w=v.parents("form"),u=c(".other_recipient",w);if(u.prop("checked")==false){q();a(v,w)}});if(c(".other_recipient").prop("checked")==false||c(".legal_form:visible").length){var t=c(".other_recipient").parents("form");c(".copy",t).each(function(u,v){var w=c(v);a(w,t)});q()}c(".other_recipient").change(function(){var y=c(this),z=y.parents("form"),u=c(".recipient_part.hidden",z),A=c(".form_group.last .form_fieldset.other"),x=c(".passport",z),v=x.parents("fieldset.form_fieldset"),w=c(".form_group.last .other input").filter(function(){return c(this).prop("required")});v.hide();x.val("");if(y.prop("checked")==true){w.attr("required","required");A.show()}else{A.hide();q();c(".copy",z).each(function(B,C){var D=c(C);a(D,z)})}});c("body").on("click",".group_switch",function(){var D=c(this),B=c(".group_switch"),w=c(".type_switches"),u=c(".order_delivery_type"),v=c(".order_delivery_options"),z=c(".order_delivery_option"),E=null,A=null,y=null,C=[],x=[];B.removeClass("active");w.removeClass("active");D.addClass("active");if(D.hasClass("delivery_group_self_pickup")){u.addClass("self_pickup").removeClass("brown_gradient_box");v.addClass("self_pickup")}else{if(D.hasClass("delivery_group_free")){u.addClass("delivery_group_free").removeClass("brown_gradient_box");v.addClass("delivery_group_free")}else{u.removeClass("delivery_group_free").removeClass("self_pickup").addClass("brown_gradient_box");v.removeClass("delivery_group_free").removeClass("self_pickup")}}C=D.attr("class").match(/delivery_group_([a-zA-Z0-9-_]+)/);w.each(function(F,G){var H=c(G);if(H.hasClass(C[0])){E=H;H.addClass("active")}else{H.removeClass("active")}});y=c(".type_switch.active",E);if(y.length){A=c("span",y)}else{y=c(".type_switch:first",E);y.addClass("active")}A=c("span",y);x=A.attr("class").match(/delivery_([a-zA-Z0-9-_]+)/);z.removeClass("active");if(D.hasClass("delivery_group_self_pickup")||D.hasClass("delivery_group_free")){c(".order_delivery_option."+C[0]).addClass("active")}else{c(".order_delivery_option."+C[0]+"."+x[0]).addClass("active")}});c(".type_switch").click(function(){var y=c(this),A=y.parents(".type_switches"),x=c(".type_switch",A),z=c(".type_switch_icon",y),w=c(".order_delivery_option"),u=[],v=[];x.removeClass("active");y.addClass("active");v=z.attr("class").match(/delivery_([a-zA-Z0-9-_]+)/);u=A.attr("class").match(/delivery_group_([a-zA-Z0-9-_]+)/);w.each(function(B,C){var D=c(C);if(D.hasClass(v[0])&&D.hasClass(u[0])){D.addClass("active")}else{D.removeClass("active")}})});c(".order_delivery_recipient_edit_tgl").click(function(){var x=c(this),y=x.parents(".recipient_info"),v=c(".contact_info",y),u=c(".common_button.big.with_arrow"),w=c("#inner_recipient");w.slideDown("slow");v.hide();u.addClass("disabled").prop("disabled",true)});c(".recipient_close").click(function(){var v=c(this),w=v.parents(".order_delivery_recipient"),u=c("#contact_info");if(u.text()){j()}});c("body").on("click",".submit_form",function(){var F=c(this),v=null,x=null,w=F.parents("form"),z=w.serialize(),C=c(".order_delivery_option_price .text_tgl"),I=c("input[id^='delivery_recipient_form_contact_city']"),D=c(".order_delivery_recipient",w),A=c("#delivery_recipient_form_contactList",w),u=c("#contact_info",w),E=c("option:first",A),H=c(".passport_field.hidden"),G=(H.length)?true:false,B={},y=c(".form_field_error",w);if(y.length){y.removeClass("form_field_error");c(".form_field_error_txt",y).remove()}c.ajax({url:settingsJS.routes.ajax_contact_cart,type:"POST",data:w.serialize(),success:function(M){if(M.result){if(M.contact.passport&&H.length){H.removeClass("hidden")}if(M.contact.lastName){u.html(M.contact.lastName+" "+M.contact.firstName+" <br />тел."+M.contact.phone+"<br />г."+M.contact.city.caption+", "+M.contact.address)}else{u.html(M.contact.organization+" <br />тел."+M.contact.phone+"<br />г."+M.contact.city.caption+", "+M.contact.address)}if(M.contact.id!=A.val()){if(G){B=c('<option value="'+M.contact.id+'">'+M.contact.lastName+" "+M.contact.firstName+" ("+M.contact.address+")</option>")}else{B=c('<option value="'+M.contact.id+'">'+M.contact.address+"</option>")}B.attr("data-contact",JSON.stringify(M.contact));B.insertAfter(E);A.val(M.contact.id)}else{if(G){c("option:selected",A).text(M.contact.lastName+" "+M.contact.firstName+" ("+M.contact.address+")").removeData("contact").data("contact",M.contact)}else{c("option:selected",A).text(M.contact.address).removeData("contact").data("contact",M.contact)}}if(I.data("city")!=M.contact.city.id){for(var L=0,J=i.length;L<J;L++){i[L].abort()}C.addClass("in-proccess");e(M.contact.city.id)}j()}else{for(var K in M.errors.contact){v=c("#delivery_recipient_form_contact_"+K);x=v.parent(".form_row_field");x.addClass("form_field_error");x.append('<div class="form_field_error_txt">'+M.errors.contact[K][0]+"</div>")}for(var K in M.errors){if(typeof M.errors[K]=="string"){v=c("#delivery_recipient_form_"+K);x=v.parent(".form_row_field");x.addClass("form_field_error");x.append('<div class="form_field_error_txt">'+M.errors[K][0]+"</div>")}}if(!c(".attention_box").length){D.prepend('<div class="attention_box error_block" >'+settingsJS.trans.form_error+"</div>")}}},error:function(){console.log("error")}});return false});c("body").on("click",".order_delivery_option",function(){var x=c(this),y=c(".delivery_btn"),w=x.parents("tr.order_delivery_option");sameClass=c(".order_delivery_option"),recipientForm=c("#inner_recipient"),recipientBlock=c("#inner_recipient"),contactBlock=c(".contact_info"),curChecked=c(".make_checked"),curInput=c(".order_delivery_option_select input[type=radio]",x),inputsToOff=c(".order_delivery_option_select input:not(."+curInput.attr("class")+")"),inputsToOn=c(".order_delivery_option_select input."+curInput.attr("class")),deliveryMetthodId=c("#delivery_recipient_form_deliveryMethod"),curPrice=c(".order_delivery_option_price span",x),deliveryCost=c("#delivery_recipient_form_deliveryCost"),deliveryPoint=c("#delivery_recipient_form_deliveryPoint"),companyName=x.data("company").replace("delivery_",""),passportField=c("#delivery_recipient_form_contact_passport"),passportBlock=c(".passport_field.hidden"),methodId=null,activeCompany=null,errorBlock=c(".attention_box"),groupClass=[],groups=c(".group_switch"),companies=c(".type_switch"),companyClass=[],cost=curPrice.text().replace(/([A-Za-zА-Яа-я\s]+)\.$/g,"");if(curInput.prop("disabled")==true){return false}if(curChecked.length){curChecked.removeClass("make_checked");for(var v=0,u=i.length;v<u;v++){i[v].abort()}e()}y.prop("disabled",true).addClass("disabled");sameClass.removeClass("selected");groups.removeClass("selected");companies.removeClass("selected");inputsToOff.prop("checked",false).prop("required",false);inputsToOn.attr("required","required");x.addClass("selected");if(x.hasClass("first")){c(".group_switch."+x.data("group")).addClass("selected");activeCompany=c(".type_switch.active ."+x.data("company"));if(activeCompany.length){activeCompany.parents(".type_switch").addClass("selected")}}if(curInput.hasClass("delivery_point")){methodId=curInput.data("delivery-method");deliveryPoint.val(curInput.val())}else{deliveryPoint.prop("required",false);deliveryPoint.removeAttr("required");deliveryPoint.val("");methodId=curInput.val()}if(!recipientForm.is(":visible")){y.prop("disabled",false).removeClass("disabled")}deliveryMetthodId.val(methodId);deliveryCost.val(cost);curInput.prop("checked",true);if(passportBlock.length&&companyName=="dellin"&&!passportField.val().length){passportField.attr("required","required");passportField.parent(".form_row_field").addClass("form_error").addClass("form_field_error");recipientBlock.show();contactBlock.hide();if(passportBlock.length){passportBlock.show()}y.prop("disabled",true).addClass("disabled")}else{if(passportBlock.length){passportBlock.hide()}if(o){recipientBlock.hide();contactBlock.show()}errorBlock.remove();passportField.parent(".form_row_field").removeClass("form_error").removeClass("form_field_error");passportField.removeAttr("required");y.prop("disabled",false).removeClass("disabled")}});c(".delivery_btn").click(function(){var z=c(this),x=c("#inner_recipient"),u=c("#delivery_form .contact_info"),w=c("input, select, textarea",x),y=c("#delivery_recipient_form_contact_passport"),v=c("#delivery_recipient_form_contactList");if(!z.hasClass("disabled")&&y.prop("required")&&!y.val()&&x.is(":hidden")){x.show();u.hide()}else{if(v.length&&!z.hasClass("disabled")&&!v.val()&&x.is(":hidden")){u.hide();z.prop("disabled",true).addClass("disabled");x.slideDown("slow")}}});c("#delivery_form").submit(function(){var u=c("#in_form"),v=c("#from_form");u.remove();v.replaceWith(u)});setTimeout(function(){e(null)},1000);f();g();c(".order_delivery_option .text_tgl").click(function(){var C=c("input[id^='delivery_recipient_form_contact_city']"),B=c(this),w=B.text().replace(/([A-Za-zА-Яа-я\s\.]+)$/gi,"");if(!C.val()||w.length){return false}var v=B.parents(".order_delivery_option"),z=c(".order_delivery_option_price .text_tgl",v),y=c(".order_delivery_option_terms",v),A=c(".order_delivery_option_select input",v),u={deliveryCityId:C.val(),deliveryMethodId:A.val(),deliveryMethod:A},x={cost:z,info:y};y.text(settingsJS.trans.order_delivery_in_proccess);B.addClass("in-proccess");k(u,x)});m();b();c(".order_delivery_option_map_tgl.text_tgl").click(function(){var w=c(this),x=w.parents("tr.order_delivery_option"),u=c("td > strong",x).text(),v=c("td > span",x).text(),y=c(".delivery_map_popup");if(c("#modal_window_header").length){c("#modal_window_header").text(u)}else{y.prepend('<h2 id="modal_window_header">'+u+"</h2>")}if(w.data("latitude")&&w.data("longitude")){c(".delivery_map_popup").modal("show");p=new ymaps.Placemark([w.data("latitude"),w.data("longitude")*1],{balloonContentHeader:u,balloonContentBody:v},{iconLayout:"default#image",iconImageHref:"/images/map_pin_active.png",iconImageSize:[26,45],iconImageOffset:[-3,-45]});d=w.data("latitude");r=w.data("longitude");ymaps.ready(l)}return false});c(".delivery_map_popup .modal_window_close").click(function(){c(".delivery_map_popup").modal("hide");h.destroy()})});var a=function(t,v){var s=[],u=/([a-zA-Z]+)_copy/,w="";s=t.attr("class").match(u);w=s[0].replace("_copy","");c("."+w,v).val(t.val());if(t.prop("required")){if(c("."+w,v).is(":hidden")&&c("."+w,v).val()){c("."+w,v).removeAttr("required")}else{c("."+w,v).attr("required","required")}}};var j=function(){var w=c("#inner_recipient"),y=c(".contact_info"),z=c(".passport_field.hidden"),v=c(".order_delivery_recipient_edit_tgl"),x=w.parents("form"),s=c(".common_button.big.with_arrow"),u=c(".form_field_error",x),t=c(".order_delivery_option input:checked");if(t.length){s.removeClass("disabled").prop("disabled",false)}if(u){u.removeClass("form_field_error");c(".form_field_error_txt",u).remove();c(".error_block").remove()}w.slideUp("slow",function(){if(v.hasClass("hidden")){v.removeClass("hidden")}y.show()})};var k=function(s,u){s.deliveryMethod.prop("disabled",true);var x;var w=0,z="",v=c(".delivery_method.make_checked"),A=s.deliveryMethod.parents(".order_delivery_option"),t="";for(var y in s){if(!w){t+=y+"="+s[y]}else{t+="&"+y+"="+s[y]}w++}x=c.ajax({url:settingsJS.routes.ajax_delivery_calculate,type:"POST",data:t,success:function(B){if(B.result.cost){z=B.result.days.transPeriod;if(B.result.orderDeliveryDays){z+="<br />"+B.result.orderDeliveryDays}u.cost.text(B.result.cost+settingsJS.trans.order_label_rub);u.info.html(z);u.cost.removeClass("in-proccess").removeClass("text_tgl");s.deliveryMethod.prop("disabled",false);if(v.length){v.prop("checked",true)}if(s.deliveryMethod.hasClass("make_checked")){s.deliveryMethod.removeClass("make_checked");o=false;A.trigger("click")}}else{u.cost.removeClass("in-proccess");u.cost.text(settingsJS.trans.order_label_delivery_re_calc);u.info.text((B.result.msg)?B.result.msg:settingsJS.trans.order_label_delivery_error_full)}},error:function(){console.log("error")}});if(s.deliveryMethod.hasClass("make_checked")){n=x}i.push(x)};var e=function(t){var s=c("input[id^='delivery_recipient_form_contact_city']");if(!s.val()){return false}c(".order_delivery_option.calculate").each(function(w,x){var z=c(x),B=c(".order_delivery_option_price .text_tgl",z),y=c(".order_delivery_option_terms",z),v=c(".order_delivery_option_select input",z),A={deliveryCityId:(t)?t:s.val(),deliveryMethodId:v.val(),deliveryMethod:v},u={cost:B,info:y};if(v.prop("checked")==true){v.prop("checked",false);v.addClass("make_checked")}k(A,u)})};var f=function(){var s=c("#inner_recipient"),u=c(".form_field_error_txt",s),t=c(".contact_info");if(u.length){s.show();t.hide()}};var g=function(){var s=c("#delivery_recipient_form_contactList option:selected");c("body").on("focus","#delivery_recipient_form_contactList",function(){s=c("option:selected",this)}).on("change","#delivery_recipient_form_contactList",function(){var y=c(this),u=c("option:selected",this),z=c(".order_delivery_option_price .text_tgl"),w=s.data("contact"),x=u.data("contact");y.trigger("blur");if(x&&w&&x.id!=w&&w.city.id!=x.city.id){for(var v=0,t=i.length;v<t;v++){i[v].abort()}z.addClass("in-proccess");e(null)}})};var m=function(){var t=c(".delivery_point:checked"),s=c(".common_button.big");if(t.length){s.removeClass("disabled").prop("disabled",false)}};var b=function(){var s=c(".delivery_method:checked"),t=s.parents("tr.order_delivery_option");if(t.hasClass("delivery_group_free")||t.hasClass("delivery_group_self_pickup")){o=true;t.trigger("click")}};var q=function(){var u=c(".recipient_info"),s=c(".copy:visible"),w=[],v=s.parents("form").find(".recipient_part.hidden"),t,x="";t=s.filter(function(){return !this.value&&c(this).prop("required")});if(t.length){v.hide()}else{s.each(function(y,z){var A=c(z);if(A.val()){if(A.hasClass("phone_copy")){w[2]=", тел. "+A.val()}else{if(A.hasClass("contactEmail_copy")){w[3]=", email "+A.val()}else{if(A.hasClass("lastName_copy")){w[0]=A.val()}else{if(A.hasClass("firstName_copy")){w[1]=" "+A.val()}else{if(A.hasClass("organization_copy")){w[0]=A.val()}}}}}}});u.html("<p>"+w.join("")+"</p>");v.show()}};function l(){h=new ymaps.Map("map",{center:[d,r],zoom:15});h.geoObjects.add(p)}})(jQuery);