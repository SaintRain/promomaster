$(function(){$("#review-rating, .upload_add, #reviews-add-pros-and-cons, .reviews-give-answer, .product_opinion_rate, .product_opinion_photos, #rewiews-more, #reviews-sort li").disableSelection();$("#reviews-sort li").on("click",function(){deleteCookie("reviews_filter");if($("#reviews-sort").hasClass("busy")){return}$("#reviews-sort").addClass("busy");$("#reviews-sort li").removeClass("text_tab_active");$("#reviews-filter li").removeClass("active");$(this).addClass("text_tab_active");var c={sort:$(this).data("sort"),slug:$("#reviews-sort").data("slug")};location.hash="reviews-sort-"+c.sort;$.ajax({type:"POST",url:$("#reviews-sort").data("url"),data:c}).done(function(d){if(d.error!==undefined){alertCustom("Ошибка!",d.error.join("<br>"),{buttons:{Ok:function(){$(this).dialog("close")}}})}else{$(".read_all").remove();$("#reviews-list").replaceWith(d.data.html);$("#reviews-sort").removeClass("busy");setCookie("reviews_sort",c.sort,{expires:3600*24*90})}})});if(location.hash.indexOf("reviews-sort")!==-1){$(location.hash+"-do").trigger("click")}if(getCookie("reviews_sort")){$("#reviews-sort li").removeClass("text_tab_active");$('li[data-sort="'+getCookie("reviews_sort")+'"]').addClass("text_tab_active")}$("#reviews-filter li").on("click",function(){if($("#reviews-filter").hasClass("busy")||$(this).hasClass("not-active")){return}$("#reviews-filter").addClass("busy");$("#reviews-sort li").removeClass("text_tab_active");$("#reviews-filter li").removeClass("active");$(this).addClass("active");var c={filterRating:$(this).data("filter"),slug:$("#reviews-sort").data("slug")};location.hash="reviews-filter-"+c.filterRating;$.ajax({type:"POST",url:$("#reviews-filter").data("url"),data:c}).done(function(d){if(d.error!==undefined){alertCustom("Ошибка!",d.error.join("<br>"),{buttons:{Ok:function(){$(this).dialog("close")}}})}else{$(".read_all").remove();$("#reviews-list").replaceWith(d.data.html);$("#reviews-filter").removeClass("busy")}});return false});if(location.hash.indexOf("reviews-filter")!==-1){$(location.hash+"-do").trigger("click")}$("#reviews-add-pros-and-cons").on("click",function(){if($(this).hasClass("pros-and-cons-is-visible")){$(this).removeClass("pros-and-cons-is-visible");$("#reviews-pros-and-cons-container").slideUp("fast");$(".rating-cancel").trigger("click");$(".review-pros, .review-cons").val("")}else{$(this).addClass("pros-and-cons-is-visible");$("#reviews-pros-and-cons-container").slideDown("fast")}triggerText($(this))});if($("#reviews-form-container").length){var b=$("<div/>").html($("#reviews-form-container").html().replace(/id=".+?"/g,"").replace(/<script.+?\/script>/g,""));b.find(".reviews-answer-form-without-this").remove()}$(".main_col_pad").on("click",".reviews-give-answer",function(){if(!$("#reviews-section").data("is-logged")){$(".modal_window").addClass("modal-in-center").modal("show");setCookie("answer_to_review",$(this).data("id"),{expires:3600*24});setCookie("redirect",document.URL.replace(/#reviews/g,"")+"#reviews",{expires:3600*24});return}if($(this).hasClass("give-answer-form-is-visible")){$(this).removeClass("give-answer-form-is-visible");$(this).next(".reviews-give-answer-form-container").slideUp("fast",function(){$(this).html("")});$(this).next(".reviews-give-answer-form-container").find("textarea").val("")}else{$(".give-answer-form-is-visible").trigger("click");$(this).addClass("give-answer-form-is-visible");var c=$(this).data("id");b.find(".reviews-parent-id").val(c);$(this).next(".reviews-give-answer-form-container").html(b.html()).slideDown("fast")}$(this).removeClass("with_icon").addClass("with_icon");triggerText($(this))});if(getCookie("answer_to_review")!==undefined){$('span.reviews-give-answer[data-id="'+getCookie("answer_to_review")+'"]').trigger("click");deleteCookie("answer_to_review")}$(".main_col_pad").on("click",".product_opinion_rate_button",function(){var d=$(this);var e=d.closest(".product_opinion_rate");var c={id:e.data("id"),type:d.hasClass("positive")?"positive":"negative"};if(!$("#reviews-section").data("is-logged")){$(".modal_window").addClass("modal-in-center").modal("show");setCookie("rate_to_review",c.id,{expires:3600*24});setCookie("rate_type",c.type,{expires:3600*24});setCookie("redirect",document.URL.replace(/#reviews/g,"")+"#reviews",{expires:3600*24});return}if(e.hasClass("busy")||e.hasClass("product_opinion_rate_disabled")||c.id===undefined){return}e.addClass("busy");$.ajax({type:"POST",url:e.data("url"),data:c}).done(function(f){if(f.error!==undefined){alertCustom("Ошибка!",f.error.join("<br>"),{buttons:{Ok:function(){$(this).dialog("close")}}})}else{e.find("span.selected").removeClass("selected");e.find("span.positive").text(f.data.count.positive);e.find("span.negative").text(f.data.count.negative);switch(f.data.action){case"+1":e.find("span.positive").addClass("selected").text(f.data.count.positive);break;case"-1":e.find("span.negative").addClass("selected").text(f.data.count.negative);break}e.removeClass("busy")}})});if(getCookie("rate_to_review")!==undefined){var a=$('div.product_opinion_rate[data-id="'+getCookie("rate_to_review")+'"] span.'+getCookie("rate_type"));if(!a.hasClass("selected")){a.trigger("click")}deleteCookie("rate_to_review");deleteCookie("rate_type")}$(".main_col_pad").on("click","#rewiews-more",function(){var d=$(this);if(d.hasClass("busy")){return}d.addClass("busy");var c={page:d.data("page"),show:d.data("show"),slug:d.data("slug"),sort:$(".text_tab_active").data("sort"),filterRating:$("#reviews-filter li.active").data("filter")};$.ajax({type:"POST",url:d.data("url"),data:c}).done(function(e){if(e.error!==undefined){alertCustom("Ошибка!",e.error.join("<br>"),{buttons:{Ok:function(){$(this).dialog("close")}}})}else{if(d.data("type")==="all"){$("ul#reviews-list").html("")}else{d.data("page",e.data.page)}$("ul#reviews-list").append(e.data.html);if(e.data.total<=(e.data.page-1)*c.show){d.remove()}d.removeClass("busy")}})});$("body").on("click",".upload_video",function(f){f.preventDefault();var c=$(this).closest("form.reviews-form").find(".core_review_form_type_remoteVideos");var d=c.data("prototype").replace(/_remote_video_index_/g,c.find("li").length);c.append(d);return false});$("body").on("change",".video-code input, .video-hosting select",function(){var g=$(this).closest("li");var e=g.find(".video-code input").val();var c=g.find(".video-hosting select option:selected").data("sys-name");g.find("iframe").hide();if(e&&c){var d=g.find(".videoPreview iframe."+c);var f=d.attr("src").split("/");f[(f.length-1)]=e;d.attr("src",f.join("/")).fadeIn(200)}});$("body").on("click",".video-remove",function(){if(confirm("Подтвердите удаление видео!")){$(this).closest("li").remove()}});$(".rating-cancel").remove();$("body").on("click",".button_send",function(f){var d=$(this).closest("form");var c="";if(!d.find(".text-review").val()){c+="Отзыв не может быть пустым!"}if(d.find(".product_rate").length&&!d.find("input.star:checked").length){c+="Укажите пожалуйста Вашу оценку!\n"}if(c){f.preventDefault();alertCustom("Сообщение",c,{buttons:{Ok:function(){$(this).dialog("close")}}});return false}})});